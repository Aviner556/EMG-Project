#include "buzzer.h"
#include "main.h"

extern TIM_HandleTypeDef htim3;
extern int currentNote;

int note[] = {390, 340, 303, 286, 255, 227, 202};
int lenght[] = {200, 200, 200, 200, 200, 200, 400};

void buzzerInit(BUZZER* buzz)
{
	buzz ->state = STATE_MUSIC_OFF;
	buzz ->size = sizeof(note)/sizeof(note[0]);
	buzz ->counter = 0;
	buzz ->currentNote = 0;
	buzz ->maxCount = 9999;
	buzz ->tone = 1;
}

void playNextNote(BUZZER* buzz)
{
	buzz ->currentNote++;
	if(buzz ->currentNote >= buzz ->size){
		buzz ->currentNote = 0;
	}
	playNote(&buzz, buzz ->currentNote);
}

void playNote(BUZZER* buzz, int noteIdx)
{
	buzz ->currentNote = noteIdx;

	__HAL_TIM_SET_COUNTER(&htim3, 0);
	__HAL_TIM_SET_AUTORELOAD(&htim3, note[currentNote]);
	__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, (note[currentNote])/2);
}

void buzzerOnTimerInterrupt(BUZZER* buzz)
{
	if(buzz ->state == STATE_MUSIC_ON){
		buzz ->counter++;
		if(buzz ->counter >= buzz ->maxCount){
			playNextNote(&buzz);
			buzz ->counter = 0;
		}
	}
}

